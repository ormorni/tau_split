use itertools::Itertools;
use rustc_hash::FxHashMap;
use std::fmt::Debug;
use std::hash::Hash;

/// A table of the 0.05 confidence interval of the chi-squared distribution with various degrees of freedom.
const CHI_SQUARED_TABLE: &[f64] = &[
    0.0, 3.8414, 5.9914, 7.8147, 9.4877, 11.0704, 12.5915, 14.0671, 15.5073, 16.9189, 18.3070,
    19.6751, 21.0260, 22.3620, 23.6847, 24.9957, 26.2962, 27.5871, 28.8692, 30.1435, 31.4104,
    32.6705, 33.9244, 35.1724, 36.4150, 37.6524, 38.8851, 40.1132, 41.3371, 42.5569, 43.7729,
    44.9853, 46.1942, 47.3998, 48.6023, 49.8018, 50.9984, 52.1923, 53.3835, 54.5722, 55.7584,
    56.9423, 58.1240, 59.3035, 60.4808, 61.6562, 62.8296, 64.0011, 65.1707, 66.3386, 67.5048,
    68.6692, 69.8321, 70.9934, 72.1532, 73.3114, 74.4683, 75.6237, 76.7778, 77.9305, 79.0819,
    80.2320, 81.3810, 82.5287, 83.6752, 84.8206, 85.9649, 87.1080, 88.2501, 89.3912, 90.5312,
    91.6702, 92.8082, 93.9453, 95.0814, 96.2166, 97.3509, 98.4843, 99.6169, 100.7486, 101.8794,
    103.0095, 104.1387, 105.2671, 106.3948, 107.5217, 108.6478, 109.7733, 110.8980, 112.0219,
    113.1452, 114.2678, 115.3897, 116.5110, 117.6316, 118.7516, 119.8709, 120.9896, 122.1077,
    123.2252, 124.3421, 125.4584, 126.5741, 127.6893, 128.8039, 129.9179, 131.0314, 132.1444,
    133.2568, 134.3687, 135.4801, 136.5910, 137.7014, 138.8113, 139.9207, 141.0297, 142.1381,
    143.2461, 144.3536, 145.4607, 146.5673, 147.6735, 148.7792, 149.8845, 150.9894, 152.0938,
    153.1979, 154.3015, 155.4047, 156.5075, 157.6099, 158.7119, 159.8135, 160.9147, 162.0156,
    163.1161, 164.2162, 165.3159, 166.4152, 167.5143, 168.6129, 169.7112, 170.8091, 171.9067,
    173.0040, 174.1009, 175.1975, 176.2938, 177.3897, 178.4853, 179.5806, 180.6755, 181.7702,
    182.8645, 183.9586, 185.0523, 186.1457, 187.2388, 188.3316, 189.4242, 190.5164, 191.6084,
    192.7000, 193.7914, 194.8825, 195.9733, 197.0639, 198.1541, 199.2441, 200.3339, 201.4233,
    202.5125, 203.6015, 204.6902, 205.7786, 206.8667, 207.9547, 209.0423, 210.1298, 211.2169,
    212.3039, 213.3906, 214.4770, 215.5632, 216.6492, 217.7349, 218.8204, 219.9057, 220.9908,
    222.0756, 223.1602, 224.2446, 225.3287, 226.4127, 227.4964, 228.5799, 229.6632, 230.7463,
    231.8291, 232.9118, 233.9942, 235.0765, 236.1585, 237.2403, 238.3220, 239.4034, 240.4846,
    241.5657, 242.6465, 243.7271, 244.8076, 245.8878, 246.9679, 248.0478, 249.1275, 250.2070,
    251.2863, 252.3654, 253.4444, 254.5232, 255.6018, 256.6802, 257.7584, 258.8365, 259.9144,
    260.9921, 262.0696, 263.1470, 264.2242, 265.3012, 266.3781, 267.4547, 268.5313, 269.6076,
    270.6838, 271.7598, 272.8357, 273.9114, 274.9870, 276.0624, 277.1376, 278.2127, 279.2876,
    280.3624, 281.4370, 282.5114, 283.5857, 284.6599, 285.7339, 286.8077, 287.8815, 288.9550,
    290.0284, 291.1017, 292.1748, 293.2478, 294.3206, 295.3933, 296.4659, 297.5383, 298.6105,
    299.6827, 300.7547, 301.8265, 302.8982, 303.9698, 305.0413, 306.1126, 307.1838, 308.2548,
    309.3257, 310.3965, 311.4671, 312.5377, 313.6081, 314.6783, 315.7485, 316.8185, 317.8883,
    318.9581, 320.0277, 321.0972, 322.1666, 323.2359, 324.3050, 325.3740, 326.4429, 327.5117,
    328.5804, 329.6489, 330.7173, 331.7856, 332.8538, 333.9218, 334.9898, 336.0576, 337.1253,
    338.1929, 339.2604, 340.3278, 341.3951, 342.4622, 343.5292, 344.5962, 345.6630, 346.7297,
    347.7963, 348.8628, 349.9292, 350.9954, 352.0616, 353.1277, 354.1936, 355.2595, 356.3252,
    357.3908, 358.4564, 359.5218, 360.5871, 361.6523, 362.7175, 363.7825, 364.8474, 365.9122,
    366.9769, 368.0415, 369.1060, 370.1705, 371.2348, 372.2990, 373.3631, 374.4271, 375.4911,
    376.5549, 377.6186, 378.6823, 379.7458, 380.8093, 381.8726, 382.9359, 383.9991, 385.0621,
    386.1251, 387.1880, 388.2508, 389.3135, 390.3761, 391.4387, 392.5011, 393.5635, 394.6257,
    395.6879, 396.7500, 397.8120, 398.8739, 399.9357, 400.9974, 402.0590, 403.1206, 404.1821,
    405.2435, 406.3048, 407.3660, 408.4271, 409.4881, 410.5491, 411.6100, 412.6708, 413.7315,
    414.7921, 415.8527, 416.9131, 417.9735, 419.0338, 420.0940, 421.1542, 422.2142, 423.2742,
    424.3341, 425.3939, 426.4537, 427.5133, 428.5729, 429.6324, 430.6919, 431.7512, 432.8105,
    433.8697, 434.9288, 435.9879, 437.0468, 438.1057, 439.1645, 440.2233, 441.2820, 442.3406,
    443.3991, 444.4575, 445.5159, 446.5742, 447.6324, 448.6906, 449.7487, 450.8067, 451.8646,
    452.9225, 453.9803, 455.0380, 456.0956, 457.1532, 458.2107, 459.2682, 460.3255, 461.3828,
    462.4401, 463.4972, 464.5543, 465.6113, 466.6683, 467.7252, 468.7820, 469.8388, 470.8954,
    471.9521, 473.0086, 474.0651, 475.1215, 476.1779, 477.2341, 478.2904, 479.3465, 480.4026,
    481.4586, 482.5146, 483.5705, 484.6263, 485.6821, 486.7378, 487.7934, 488.8490, 489.9045,
    490.9599, 492.0153, 493.0706, 494.1259, 495.1811, 496.2362, 497.2913, 498.3463, 499.4013,
    500.4562, 501.5110, 502.5658, 503.6205, 504.6751, 505.7297, 506.7842, 507.8387, 508.8931,
    509.9474, 511.0017, 512.0560, 513.1101, 514.1642, 515.2183, 516.2723, 517.3262, 518.3801,
    519.4339, 520.4877, 521.5414, 522.5950, 523.6486, 524.7022, 525.7556, 526.8091, 527.8624,
    528.9157, 529.9690, 531.0222, 532.0753, 533.1284, 534.1814, 535.2344, 536.2873, 537.3402,
    538.3930, 539.4458, 540.4985, 541.5511, 542.6037, 543.6563, 544.7088, 545.7612, 546.8136,
    547.8659, 548.9182, 549.9704, 551.0226, 552.0747, 553.1268, 554.1788, 555.2307, 556.2826,
    557.3345, 558.3863, 559.4381, 560.4898, 561.5414, 562.5930, 563.6446, 564.6961, 565.7475,
    566.7989, 567.8503, 568.9016, 569.9528, 571.0040, 572.0552, 573.1063, 574.1573, 575.2084,
    576.2593, 577.3102, 578.3611, 579.4119, 580.4626, 581.5134, 582.5640, 583.6146, 584.6652,
    585.7157, 586.7662, 587.8166, 588.8670, 589.9173, 590.9676, 592.0178, 593.0680, 594.1182,
    595.1683, 596.2183, 597.2683, 598.3183, 599.3682, 600.4181, 601.4679, 602.5177, 603.5674,
    604.6171, 605.6667, 606.7163, 607.7659, 608.8154, 609.8648, 610.9142, 611.9636, 613.0129,
    614.0622, 615.1115, 616.1606, 617.2098, 618.2589, 619.3080, 620.3570, 621.4060, 622.4549,
    623.5038, 624.5526, 625.6014, 626.6502, 627.6989, 628.7476, 629.7962, 630.8448, 631.8933,
    632.9418, 633.9903, 635.0387, 636.0871, 637.1354, 638.1837, 639.2320, 640.2802, 641.3284,
    642.3765, 643.4246, 644.4726, 645.5206, 646.5686, 647.6165, 648.6644, 649.7122, 650.7600,
    651.8078, 652.8555, 653.9032, 654.9508, 655.9984, 657.0460, 658.0935, 659.1410, 660.1884,
    661.2359, 662.2832, 663.3305, 664.3778, 665.4251, 666.4723, 667.5194, 668.5666, 669.6137,
    670.6607, 671.7077, 672.7547, 673.8017, 674.8486, 675.8954, 676.9422, 677.9890, 679.0358,
    680.0825, 681.1292, 682.1758, 683.2224, 684.2689, 685.3155, 686.3620, 687.4084, 688.4548,
    689.5012, 690.5475, 691.5938, 692.6401, 693.6863, 694.7325, 695.7787, 696.8248, 697.8709,
    698.9169, 699.9629, 701.0089, 702.0548, 703.1007, 704.1466, 705.1924, 706.2382, 707.2840,
    708.3297, 709.3754, 710.4211, 711.4667, 712.5123, 713.5578, 714.6033, 715.6488, 716.6943,
    717.7397, 718.7850, 719.8304, 720.8757, 721.9210, 722.9662, 724.0114, 725.0566, 726.1017,
    727.1468, 728.1919, 729.2369, 730.2819, 731.3269, 732.3718, 733.4167, 734.4616, 735.5064,
    736.5512, 737.5960, 738.6407, 739.6854, 740.7301, 741.7747, 742.8193, 743.8639, 744.9084,
    745.9529, 746.9974, 748.0418, 749.0863, 750.1306, 751.1750, 752.2193, 753.2636, 754.3078,
    755.3520, 756.3962, 757.4403, 758.4845, 759.5285, 760.5726, 761.6166, 762.6606, 763.7046,
    764.7485, 765.7924, 766.8363, 767.8801, 768.9239, 769.9677, 771.0114, 772.0551, 773.0988,
    774.1425, 775.1861, 776.2297, 777.2732, 778.3168, 779.3603, 780.4037, 781.4472, 782.4906,
    783.5339, 784.5773, 785.6206, 786.6639, 787.7071, 788.7504, 789.7936, 790.8367, 791.8799,
    792.9230, 793.9660, 795.0091, 796.0521, 797.0951, 798.1381, 799.1810, 800.2239, 801.2668,
    802.3096, 803.3524, 804.3952, 805.4380, 806.4807, 807.5234, 808.5660, 809.6087, 810.6513,
    811.6939, 812.7364, 813.7790, 814.8215, 815.8639, 816.9064, 817.9488, 818.9912, 820.0335,
    821.0759, 822.1182, 823.1604, 824.2027, 825.2449, 826.2871, 827.3292, 828.3714, 829.4135,
    830.4556, 831.4976, 832.5396, 833.5816, 834.6236, 835.6655, 836.7075, 837.7493, 838.7912,
    839.8330, 840.8748, 841.9166, 842.9584, 844.0001, 845.0418, 846.0835, 847.1251, 848.1667,
    849.2083, 850.2499, 851.2914, 852.3329, 853.3744, 854.4159, 855.4573, 856.4987, 857.5401,
    858.5815, 859.6228, 860.6641, 861.7054, 862.7466, 863.7878, 864.8290, 865.8702, 866.9114,
    867.9525, 868.9936, 870.0346, 871.0757, 872.1167, 873.1577, 874.1987, 875.2396, 876.2805,
    877.3214, 878.3623, 879.4031, 880.4439, 881.4847, 882.5255, 883.5662, 884.6069, 885.6476,
    886.6883, 887.7289, 888.7696, 889.8102, 890.8507, 891.8913, 892.9318, 893.9723, 895.0127,
    896.0532, 897.0936, 898.1340, 899.1744, 900.2147, 901.2550, 902.2953, 903.3356, 904.3759,
    905.4161, 906.4563, 907.4965, 908.5366, 909.5768, 910.6169, 911.6569, 912.6970, 913.7370,
    914.7770, 915.8170, 916.8570, 917.8969, 918.9369, 919.9767, 921.0166, 922.0565, 923.0963,
    924.1361, 925.1759, 926.2156, 927.2553, 928.2951, 929.3347, 930.3744, 931.4140, 932.4536,
    933.4932, 934.5328, 935.5724, 936.6119, 937.6514, 938.6909, 939.7303, 940.7697, 941.8092,
    942.8485, 943.8879, 944.9272, 945.9666, 947.0059, 948.0451, 949.0844, 950.1236, 951.1628,
    952.2020, 953.2412, 954.2803, 955.3194, 956.3585, 957.3976, 958.4367, 959.4757, 960.5147,
    961.5537, 962.5926, 963.6316, 964.6705, 965.7094, 966.7483, 967.7871, 968.8260, 969.8648,
    970.9036, 971.9423, 972.9811, 974.0198, 975.0585, 976.0972, 977.1359, 978.1745, 979.2131,
    980.2517, 981.2903, 982.3289, 983.3674, 984.4059, 985.4444, 986.4829, 987.5213, 988.5597,
    989.5982, 990.6365, 991.6749, 992.7133, 993.7516, 994.7899, 995.8282, 996.8664, 997.9047,
    998.9429, 999.9811, 1001.0193, 1002.0574, 1003.0956, 1004.1337, 1005.1718, 1006.2099,
    1007.2479, 1008.2860, 1009.3240, 1010.3620, 1011.3999, 1012.4379, 1013.4758, 1014.5138,
    1015.5516, 1016.5895, 1017.6274, 1018.6652, 1019.7030, 1020.7408, 1021.7786, 1022.8164,
    1023.8541, 1024.8918, 1025.9295, 1026.9672, 1028.0048, 1029.0425, 1030.0801, 1031.1177,
    1032.1553, 1033.1928, 1034.2304, 1035.2679, 1036.3054, 1037.3429, 1038.3803, 1039.4178,
    1040.4552, 1041.4926, 1042.5300, 1043.5673, 1044.6047, 1045.6420, 1046.6793, 1047.7166,
    1048.7539, 1049.7911, 1050.8283, 1051.8655, 1052.9027, 1053.9399, 1054.9771, 1056.0142,
    1057.0513, 1058.0884, 1059.1255, 1060.1625, 1061.1996, 1062.2366, 1063.2736, 1064.3106,
    1065.3475, 1066.3845, 1067.4214, 1068.4583, 1069.4952, 1070.5321, 1071.5689, 1072.6058,
    1073.6426,
];

/// A simple test for if two categorical distributions are the same.
pub fn same_categorical_dist<K: Hash + Eq + Debug>(
    d1: FxHashMap<K, u64>,
    d2: FxHashMap<K, u64>,
) -> bool {
    let t1 = d1.values().sum::<u64>() as f64;
    let t2 = d2.values().sum::<u64>() as f64;

    // Running the chi-squared test.
    let chi_squared = d1
        .iter()
        .map(|(key, observed)| {
            let expected = (observed + d2.get(key).unwrap_or(&0)) as f64 * t1 / (t1 + t2);
            // println!("{key:?} {expected:?} {observed:?}");
            (*observed as f64 - expected).powi(2) / expected
        })
        .sum::<f64>();
    let dof = d1.keys().chain(d2.keys()).unique().count() - 1;
    chi_squared < CHI_SQUARED_TABLE[dof]
}
